name: Security Scan

# This workflow is the first line of defense against introducing vulnerabilities
# It runs static analysis tools that Sentinel would use to scan itself

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  bandit:
    name: Bandit - Python Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          # Scan for common security issues
          # Severity HIGH or CRITICAL = blocking
          # Focus on command injection, hardcoded secrets, unsafe subprocess
          bandit -r core/ \
            -f json \
            -o bandit-report.json \
            --severity-level medium \
            --confidence-level medium

      - name: Check critical findings
        run: |
          # Fail if we find shell=True or other critical issues
          if grep -q '"issue_severity": "HIGH"' bandit-report.json; then
            echo "‚ùå HIGH severity security issues found"
            bandit -r core/ --severity-level high
            exit 1
          fi

          if grep -q '"issue_severity": "CRITICAL"' bandit-report.json; then
            echo "‚ùå CRITICAL security issues found"
            bandit -r core/ --severity-level high
            exit 1
          fi

          echo "‚úÖ No critical security issues detected"

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

  semgrep:
    name: Semgrep - Semantic Code Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/python
            p/command-injection
            p/secrets
          generateSarif: true

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

  forbidden-patterns:
    name: Forbidden Pattern Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for shell=True
        run: |
          echo "üîç Searching for dangerous shell=True usage..."

          # Find all shell=True occurrences
          if grep -r "shell=True" core/ --include="*.py"; then
            echo ""
            echo "‚ùå CRITICAL: shell=True found in code"
            echo "This is a command injection vulnerability."
            echo "Use shell=False with list arguments instead."
            exit 1
          fi

          echo "‚úÖ No shell=True found"

      - name: Check for unsafe subprocess patterns
        run: |
          echo "üîç Searching for unsafe subprocess patterns..."

          # Check for common unsafe patterns
          UNSAFE_PATTERNS=(
            "os.system("
            "eval("
            "exec("
            "__import__"
            "subprocess.call.*shell"
          )

          FOUND_ISSUES=0

          for pattern in "${UNSAFE_PATTERNS[@]}"; do
            if grep -r -E "$pattern" core/ --include="*.py"; then
              echo "‚ùå Found unsafe pattern: $pattern"
              FOUND_ISSUES=1
            fi
          done

          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "‚ùå Unsafe code patterns detected"
            exit 1
          fi

          echo "‚úÖ No unsafe patterns found"

      - name: Check for hardcoded secrets
        run: |
          echo "üîç Searching for potential hardcoded secrets..."

          # Look for common secret patterns
          if grep -r -E "(password|secret|api_key|token)\s*=\s*['\"][^'\"]{8,}" core/ --include="*.py"; then
            echo "‚ö†Ô∏è  Warning: Potential hardcoded secrets found"
            echo "Review these manually - may be false positives"
            # Don't fail, just warn
          else
            echo "‚úÖ No obvious hardcoded secrets"
          fi

      - name: Check for TODO/FIXME security issues
        run: |
          echo "üîç Searching for security-related TODOs..."

          # Find security-related TODOs
          grep -r -i "TODO.*secur" core/ --include="*.py" || true
          grep -r -i "FIXME.*secur" core/ --include="*.py" || true
          grep -r -i "XXX.*secur" core/ --include="*.py" || true

          echo "‚úÖ Security TODO scan complete"

  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install safety
        run: pip install safety

      - name: Check for vulnerable dependencies
        run: |
          # Scan requirements.txt for known vulnerabilities
          pip install -r requirements.txt

          # Generate dependency list
          pip freeze > installed-deps.txt

          # Run safety check (continue on error to see all issues)
          safety check --file installed-deps.txt --json > safety-report.json || true

          # Check for critical vulnerabilities
          if grep -q '"severity": "critical"' safety-report.json 2>/dev/null; then
            echo "‚ùå CRITICAL vulnerabilities found in dependencies"
            safety check --file installed-deps.txt
            exit 1
          fi

          if grep -q '"severity": "high"' safety-report.json 2>/dev/null; then
            echo "‚ö†Ô∏è  HIGH severity vulnerabilities found"
            safety check --file installed-deps.txt
            # Warning only, don't block
          fi

          echo "‚úÖ No critical dependency vulnerabilities"

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-security-report
          path: |
            safety-report.json
            installed-deps.txt
          retention-days: 30

  attack-surface-analysis:
    name: Attack Surface Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install radon vulture

      - name: Measure code complexity
        run: |
          echo "üìä Analyzing code complexity..."

          # High complexity = more attack surface
          radon cc core/ -a -nb

          # Fail if average complexity is too high
          COMPLEXITY=$(radon cc core/ -a -nb | grep "Average complexity" | awk '{print $NF}' | cut -d'(' -f1)
          echo "Average complexity: $COMPLEXITY"

      - name: Find dead code
        run: |
          echo "üîç Searching for dead code..."

          # Dead code can hide vulnerabilities
          vulture core/ --min-confidence 80 || true

      - name: Count subprocess executions
        run: |
          echo "üîç Counting subprocess execution points..."

          SUBPROCESS_COUNT=$(grep -r "subprocess\." core/ --include="*.py" | wc -l)
          ASYNCIO_SUBPROCESS_COUNT=$(grep -r "asyncio.create_subprocess" core/ --include="*.py" | wc -l)

          TOTAL=$((SUBPROCESS_COUNT + ASYNCIO_SUBPROCESS_COUNT))

          echo "Found $TOTAL subprocess execution points"
          echo "Each is a potential attack vector - review carefully"

          # List all execution points
          echo "Subprocess locations:"
          grep -rn "subprocess\." core/ --include="*.py" || true
          grep -rn "asyncio.create_subprocess" core/ --include="*.py" || true

      - name: Identify privilege escalation risks
        run: |
          echo "üîç Checking for privilege escalation risks..."

          # Check for sudo, setuid, capabilities
          grep -r "sudo\|setuid\|CAP_" core/ --include="*.py" || echo "‚úÖ No obvious privilege escalation"

      - name: Network exposure analysis
        run: |
          echo "üîç Analyzing network exposure..."

          # Find all network bindings
          echo "Server bindings:"
          grep -rn "0.0.0.0\|host=" core/ --include="*.py" || true

          # Check for unsafe defaults
          if grep -q '0.0.0.0' core/; then
            echo "‚ö†Ô∏è  Warning: 0.0.0.0 binding found (exposes to network)"
          fi

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [bandit, semgrep, forbidden-patterns, dependency-check, attack-surface-analysis]
    if: always()

    steps:
      - name: Check all security scans passed
        run: |
          echo "Security scan summary:"
          echo "- Bandit: ${{ needs.bandit.result }}"
          echo "- Semgrep: ${{ needs.semgrep.result }}"
          echo "- Forbidden patterns: ${{ needs.forbidden-patterns.result }}"
          echo "- Dependency check: ${{ needs.dependency-check.result }}"
          echo "- Attack surface: ${{ needs.attack-surface-analysis.result }}"

          if [ "${{ needs.bandit.result }}" != "success" ] || \
             [ "${{ needs.forbidden-patterns.result }}" != "success" ]; then
            echo ""
            echo "‚ùå SECURITY GATE FAILED"
            echo "Critical security issues must be fixed before merge"
            exit 1
          fi

          echo ""
          echo "‚úÖ Security gates passed"
