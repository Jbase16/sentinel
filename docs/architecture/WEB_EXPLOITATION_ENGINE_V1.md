# Sentinel Web Exploitation Engine v1

Status: Proposed
Owner: Core Engine
Target: Production-grade bug bounty capability
Audience: Implementation Agent / Core Contributors

⸻

1. Problem Statement

Sentinel currently provides:
	•	Infrastructure reconnaissance
	•	Tool orchestration
	•	Scope enforcement
	•	Event-driven decision logging
	•	Deterministic replay of high-level actions

Sentinel does not currently provide:
	•	Stateful web application testing
	•	JavaScript-aware surface discovery
	•	Parameter mutation and response differencing
	•	Authenticated multi-principal testing
	•	Browser-driven SPA analysis
	•	Evidence-bundled exploit confirmation

This document defines the architecture required to transform Sentinel into a deterministic, policy-enforced web application vulnerability analysis engine.

⸻

2. Design Constraints (MUST NOT VIOLATE)
	1.	All network activity MUST route through ExecutionPolicy.
	2.	No finding may be marked CONFIRMED without an EvidenceBundle.
	3.	No destructive HTTP methods (PUT, DELETE, PATCH) may execute unless explicitly enabled in mission config.
	4.	All new subsystems MUST emit structured events to EventBus.
	5.	ScopeRegistry resolution MUST be enforced at:
	•	HTTP request level
	•	Browser navigation level
	6.	Mutation engines MUST be bounded by mission ceilings.

If an implementation conflicts with these invariants, the invariant wins.

⸻

3. High-Level Architecture

WebMission
   ↓
Surface Discovery (Crawler + JS Intel)
   ↓
SurfaceRegistry
   ↓
WebContext (Session / Principals)
   ↓
Mutation Engine
   ↓
Response Differencing Engine
   ↓
Evidence Engine
   ↓
Replay Generator
   ↓
Structured Report

All transitions emit events.
All actions are policy-checked.
All findings are replayable.

⸻

4. New Module Layout

Create the following module tree:

core/web/
    mission.py
    surface_registry.py
    crawler.py
    js_intel.py
    context.py

    auth/
        base.py
        form_login.py
        scripted_login.py

    mutate/
        base.py
        reflection.py
        sqli.py
        idor.py
        ssrf.py

    diff/
        baseline.py
        delta.py

    browser/
        playwright_runner.py

    evidence/
        bundle.py
        artifacts.py

    replay/
        generator.py

Each file MUST implement only the responsibilities defined below.

⸻

5. Domain Models

All models MUST be typed (dataclasses or pydantic).

5.1 WebMission

Location: core/web/mission.py

Purpose: Canonical configuration container for web testing.

Fields:
	•	mission_id: str
	•	origin: str
	•	allowed_origins: list[str]
	•	max_depth: int
	•	max_pages: int
	•	exploit_ceiling: int
	•	oob_allowed: bool
	•	destructive_methods_allowed: bool
	•	auth_mode: Literal[“none”,“form”,“scripted”,“imported”]
	•	principal_count: int

ExecutionPolicy MUST consume WebMission.

⸻

5.2 SurfaceRegistry

Location: core/web/surface_registry.py

Purpose: Central inventory of discovered web surface.

Tracks:
	•	URLs
	•	Endpoints
	•	Forms
	•	JS Assets
	•	EndpointCandidates

Deduplication key:
origin + path + sorted(query_keys)

Must be concurrency-safe.

⸻

5.3 WebContext

Location: core/web/context.py

Purpose: Stateful session container per principal.

Fields:
	•	cookie_jar
	•	default_headers
	•	csrf_tokens
	•	auth_tokens
	•	principal_id
	•	request_counter

All HTTP actions MUST require WebContext.

⸻

5.4 ParamSpec

Location: core/web/mutate/base.py

Represents a discovered parameter.

Fields:
	•	name
	•	location: Literal["query","path","json","form","header"]
	•	example_value
	•	type_guess
	•	reflection_hint: bool

Produced by parameter extraction engine.

⸻

5.5 BaselineSignature

Location: core/web/diff/baseline.py

Fields:
	•	status_code
	•	body_hash
	•	normalized_hash
	•	dom_hash
	•	json_shape_hash
	•	timing_profile

Used for delta comparison.

⸻

5.6 EvidenceBundle (Versioned)

Location: core/web/evidence/bundle.py

Fields:
	•	finding_id
	•	request_sequence
	•	response_snapshots
	•	delta_metrics
	•	artifacts (paths)
	•	replay_script_path
	•	version

Version MUST increment on schema changes.

⸻

6. Surface Discovery Layer

6.1 HTTP Crawler

Location: crawler.py

Responsibilities:
	•	Fetch HTML within scope
	•	Parse links, forms, script src
	•	Normalize URLs
	•	Enforce max_depth
	•	Enforce max_pages
	•	Emit event: WEB_SURFACE_DISCOVERED

Must not:
	•	Execute JS
	•	Follow off-scope redirects

⸻

6.2 JS Intel Engine

Location: js_intel.py

Responsibilities:
	•	Parse JS bundles
	•	Extract endpoint patterns:
	•	/api/*
	•	/rest/*
	•	/graphql
	•	Detect source maps
	•	Extract potential secrets (bounded, non-exfiltrative)

Emit event: WEB_ENDPOINT_REGISTERED

Must enforce:
	•	Bundle size limit
	•	Scope restrictions

⸻

7. Authentication Engine

7.1 Form Login

Location: auth/form_login.py

Responsibilities:
	•	Identify login form
	•	Extract CSRF token
	•	Submit credentials
	•	Detect success condition
	•	Update WebContext

Emit event: WEB_AUTH_SUCCESS

Must not:
	•	Persist credentials in logs
	•	Store raw passwords in events

⸻

7.2 Multi-Principal

WebMission.principal_count > 1 MUST create isolated WebContexts.

Used for IDOR differential analysis.

⸻

8. Mutation Engine

Location: mutate/

Invariants
	•	Every mutation MUST:
	•	Establish baseline first
	•	Record delta metrics
	•	Respect exploit_ceiling

Required Mutators (v1)

ReflectionMutator

Detects reflected canary tokens.

SQLiMutator
	•	Error-based first
	•	Then bounded timing-based
	•	Statistical confirmation required

IDORMutator
	•	Detect object identifiers
	•	Replay request under alternate principal
	•	Compare body similarity

SSRFMutator
	•	Only active if oob_allowed
	•	Must use approved OOB provider
	•	Confirm via OOB callback event

Each mutation attempt emits:
	•	WEB_MUTATION_ATTEMPT
	•	WEB_DELTA_DETECTED (if applicable)

⸻

9. Response Differencing Engine

Location: diff/

Responsibilities:
	•	Compute baseline signature
	•	Normalize volatile fields
	•	Compare mutated response
	•	Produce structured delta vector

Delta must include:
	•	status_delta
	•	body_length_delta
	•	structural_delta
	•	timing_delta

Must reduce false positives.

⸻

10. Browser Engine (Playwright)

Location: browser/playwright_runner.py

Responsibilities:
	•	Navigate origin
	•	Capture runtime XHR/fetch calls
	•	Extract dynamic routes
	•	Capture DOM snapshot
	•	Capture HAR (optional)

Constraints:
	•	Must enforce scope on navigation
	•	Must deny new origin navigation unless allowed
	•	Must disable downloads by default

Emit event:
	•	WEB_BROWSER_ROUTE_DISCOVERED

⸻

11. Evidence & Replay

Evidence Engine

Location: evidence/

Responsibilities:
	•	Store request/response pairs
	•	Redact sensitive tokens
	•	Store artifacts
	•	Link to finding

Replay Generator

Location: replay/generator.py

Responsibilities:
	•	Generate deterministic Python script
	•	Reconstruct minimal exploit sequence
	•	Validate delta expectations
	•	Store path in EvidenceBundle

Replay MUST succeed under same mission constraints.

⸻

12. Event Additions

Add to event taxonomy:
	•	WEB_SURFACE_DISCOVERED
	•	WEB_ENDPOINT_REGISTERED
	•	WEB_AUTH_SUCCESS
	•	WEB_MUTATION_ATTEMPT
	•	WEB_DELTA_DETECTED
	•	WEB_FINDING_CONFIRMED
	•	WEB_EVIDENCE_BUNDLE_CREATED

Each MUST define structured payload schema.

⸻

13. Acceptance Criteria (Non-Negotiable)

Milestone A

Local Juice Shop:
	•	≥ 20 endpoints discovered via JS parsing
	•	Surface expansion > 1

Milestone B

Authenticated crawl:
	•	Sentinel logs in successfully
	•	Auth-only endpoints discovered

Milestone C

Reflection detection:
	•	Search param reflection detected
	•	Delta recorded

Milestone D

IDOR detection:
	•	Differential access detected across principals

Milestone E

Replay:
	•	Generated replay script reproduces delta

If these are not satisfied, implementation is incomplete.

⸻

14. Prohibited Behaviors
	•	Unbounded fuzzing
	•	Infinite crawl loops
	•	Silent exploit attempts
	•	Storing plaintext credentials
	•	Skipping ExecutionPolicy

Violations are architectural failures.

⸻

15. Definition of Done

Sentinel can:
	1.	Discover modern SPA endpoints
	2.	Authenticate and persist session
	3.	Mutate parameters safely
	4.	Confirm behavioral deltas
	5.	Produce replayable evidence
	6.	Respect scope and policy at every layer

Only then is the Web Exploitation Engine considered v1 complete.
